---
import SocialIcons from "./SocialIcons.astro";
import { PlayIcon} from "../icons"

interface Props {
  title: string;
  album:string;
  releaseDate?: string;
  cover?: string;
  links?: Record<string, string>;
  latest?: boolean;
}
const { title, releaseDate, cover, links = {},album, latest }: Props = Astro.props;

const d = releaseDate ? new Date(releaseDate) : null;
const pretty = d
  ? new Intl.DateTimeFormat("es-AR", { dateStyle: "long" }).format(d)
  : null;

/** Extrae un ID válido de YouTube (watch, youtu.be, shorts, embed, music) y limpia params extra */
function getYouTubeId(url?: string | null): string | null {
  if (!url) return null;
  try {
    // quita parámetros “si” u otros trackers
    const clean = url.replace(/(\?|\&)si=[^&]+/g, "");
    const u = new URL(clean);
    const host = u.hostname.replace(/^m\./, ""); // m.youtube.com -> youtube.com

    if (host.includes("youtu.be")) {
      // https://youtu.be/VIDEOID
      return u.pathname.slice(1) || null;
    }
    if (host.includes("youtube.com") || host.includes("music.youtube.com")) {
      if (u.pathname === "/watch") return u.searchParams.get("v");
      if (u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2] || null;
      if (u.pathname.startsWith("/embed/")) return u.pathname.split("/")[2] || null;
    }
    return null;
  } catch {
    return null;
  }
}

const youTubeId = getYouTubeId(links.youtube);
const showVideo = Boolean(latest && youTubeId);

// URL de embed (usa youtube.com en vez de nocookie; mejor compatibilidad móvil)
const embedSrc = youTubeId
  ? `https://www.youtube.com/embed/${youTubeId}?playsinline=1&rel=0&modestbranding=1`
  : null;

---

<div class="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 hover:border-white/20 transition-all duration-300 hover:bg-white/10 hover:shadow-xl group overflow-hidden">

  {showVideo ? (
    /* Video responsive 16:9 */
    <div class="w-full">
      <div class="relative w-full" style="padding-top:56.25%">
        <iframe
          class="absolute inset-0 w-full h-full"
          src={embedSrc}
          title={`YouTube: ${title}`}
          frameborder="0"
          loading="lazy"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
        ></iframe>
      </div>

      <div class="flex items-center justify-between gap-4 p-3">
        <div class="flex-1">
          <h3 class="text-foreground font-medium text-left">{title}</h3>
          <p class="text-foreground/60 text-sm text-left capitalize">{album}</p>
        </div>

        {/* Botón por si el embed está restringido en mobile */}
        {links.youtube && (
          <a
            href={links.youtube}
            target="_blank"
            rel="noopener noreferrer"
            class="text-xs px-2 py-1 rounded bg-muted text-muted-foreground hover:text-foreground"
          >
            Abrir en YouTube
          </a>
        )}
      </div>
    </div>
  ) : (
    /* Cover por defecto */
    <div class="flex items-center justify-between gap-4 p-2">
      <div class="relative">
        {cover && (
          <>
            <img
              src={cover}
              alt={title}
              class="size-16 rounded-lg object-cover"
              loading="lazy"
              decoding="async"
            />
            <div class="absolute inset-0 bg-black/30 backdrop-blur-xl rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
              <PlayIcon size={16} class="text-white" />
            </div>
          </>
        )}
      </div>
      <div class="flex-1">
        <h3 class="text-foreground font-medium text-left">{title}</h3>
        <p class="text-foreground/60 text-sm text-left capitalize">{album}</p>
      </div>
    </div>
  )}

  <div class="flex items-center justify-center bg-white/5 pt-2 px-2">
    <SocialIcons links={links} size={32} />
  </div>
</div>